<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ChatBot - Formulaire de Collecte</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .form-content {
            padding: 40px;
        }
        
        .progress-bar {
            background: #ecf0f1;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #3498db, #2ecc71);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .question-group {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .question-group.active {
            background: #e3f2fd;
            border-left-color: #2196f3;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.1);
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.05em;
        }
        
        .required {
            color: #e74c3c;
        }
        
        input[type="text"], input[type="email"], select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
            transition: all 0.2s ease;
        }
        
        .checkbox-item:hover {
            background: #f0f8ff;
            border-color: #3498db;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }
        
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-save {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.3);
        }
        
        .btn-send {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
        }
        
        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(142, 68, 173, 0.3);
        }
        
        .btn-export {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }
        
        .btn-clear {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-clear:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3);
        }
        
        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .question-counter {
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .help-text {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }
        
            @media (max-width: 768px) {
            .form-content {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Test ChatBot - Collecte de donn√©es</h1>
            <p>Formulaire pour l'√©valuation des r√©ponses du ChatBot</p>
        </div>
        
        <div class="form-content">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="statusMessage"></div>
            
            <form id="chatbotForm">
                <!-- Informations g√©n√©rales -->
                <div class="question-group">
                    <label for="userName">Nom et Email <span class="required">*</span></label>
                    <input type="email" id="userName" name="userName" required 
                           placeholder="prenom.nom@entreprise.com">
                </div>
                
                <!-- Question en cours -->
                <div class="question-group">
                    <div class="question-counter">Question <span id="questionNumber">1</span> sur 5</div>
                    <label for="questionNum">Num√©ro de la question <span class="required">*</span></label>
                    <select id="questionNum" name="questionNum" required>
                        <option value="">S√©lectionnez...</option>
                        <option value="1">Question 1</option>
                        <option value="2">Question 2</option>
                        <option value="3">Question 3</option>
                        <option value="4">Question 4</option>
                        <option value="5">Question 5</option>
                    </select>
                </div>
                
                <!-- Th√®mes concern√©s -->
                <div class="question-group">
                    <label>Th√®mes concern√©s par cette question <span class="required">*</span></label>
                    <p class="help-text">Cochez tous les th√®mes que votre question aborde</p>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="theme1" name="themes" value="Absences">
                            <label for="theme1">Absences</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="theme2" name="themes" value="Annulation">
                            <label for="theme2">Annulation</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="theme3" name="themes" value="Conseil">
                            <label for="theme3">Conseil</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="theme4" name="themes" value="Contr√¥le">
                            <label for="theme4">Contr√¥le</label>
                        </div>
                    </div>
                </div>
                
                <!-- Sous-th√®me principal -->
                <div class="question-group">
                    <label for="subTheme">Sous-th√®me principal <span class="required">*</span></label>
                    <select id="subTheme" name="subTheme" required>
                        <option value="">S√©lectionnez un sous-th√®me...</option>
                        <!-- Absences -->
                        <optgroup label="Absences">
                            <option value="Absence entretien">Absence entretien</option>
                            <option value="Annonce d'une absence">Annonce d'une absence</option>
                        </optgroup>
                        <!-- Annulation -->
                        <optgroup label="Annulation">
                            <option value="Annulation d'un dossier">Annulation d'un dossier</option>
                            <option value="Diagnostic discordant">Diagnostic discordant</option>
                            <option value="√âvaluation approfondie">√âvaluation approfondie</option>
                            <option value="Fin de dossier">Fin de dossier</option>
                            <option value="Mesures d'insertion">Mesures d'insertion</option>
                            <option value="Octroi STAFE">Octroi STAFE</option>
                        </optgroup>
                        <!-- Conseil -->
                        <optgroup label="Conseil">
                            <option value="Strat√©gie de r√©insertion">Strat√©gie de r√©insertion</option>
                            <option value="Structure des entretiens">Structure des entretiens</option>
                            <option value="Task Force Entretiens">Task Force Entretiens</option>
                            <option value="Visioconf√©rence">Visioconf√©rence</option>
                        </optgroup>
                        <!-- Contr√¥le -->
                        <optgroup label="Contr√¥le">
                            <option value="Aptitude au placement">Aptitude au placement</option>
                            <option value="Restitution des recherches d'emploi">Restitution des recherches d'emploi</option>
                        </optgroup>
                    </select>
                </div>
                
                <!-- Question pos√©e -->
                <div class="question-group">
                    <label for="questionAsked">Question pos√©e au ChatBot <span class="required">*</span></label>
                    <p class="help-text">Copiez-collez exactement la question que vous avez pos√©e</p>
                    <textarea id="questionAsked" name="questionAsked" required 
                              placeholder="Coller votre question ici..."></textarea>
                </div>
                
                <!-- R√©ponse re√ßue -->
                <div class="question-group">
                    <label for="botResponse">R√©ponse re√ßue du ChatBot <span class="required">*</span></label>
                    <p class="help-text">Copiez-collez la r√©ponse compl√®te du ChatBot</p>
                    <textarea id="botResponse" name="botResponse" required 
                              placeholder="Coller la r√©ponse du ChatBot ici..."></textarea>
                </div>
                
                <!-- R√©ponse attendue -->
                <div class="question-group">
                    <label for="expectedResponse">R√©ponse que vous attendiez <span class="required">*</span></label>
                    <p class="help-text">D√©crivez ce que vous esp√©riez comme r√©ponse</p>
                    <textarea id="expectedResponse" name="expectedResponse" required 
                              placeholder="D√©crivez votre r√©ponse attendue..."></textarea>
                </div>
                
                <!-- Commentaires -->
                <div class="question-group">
                    <label for="comments">Commentaires additionnels</label>
                    <p class="help-text">Remarques, suggestions, observations...</p>
                    <textarea id="comments" name="comments" 
                              placeholder="Commentaires optionnels..."></textarea>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn-save" onclick="saveForm()">
                        üíæ Sauvegarder cette question
                    </button>
                    <button type="button" class="btn-send" onclick="sendToGoogleSheets()">
                        üì§ Envoyer vers Google Sheets
                    </button>
                    <button type="button" class="btn-export" onclick="exportToPDF()">
                        üìÑ Exporter en PDF
                    </button>
                    <button type="button" class="btn-clear" onclick="clearForm()">
                        üóëÔ∏è Vider le formulaire
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration Google Sheets
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwr0MkIJrHjuuQYowE_b0D3Vl1SYhbDL1kLkPFv2mSRFMiW76zodBAUULe5xtNbQak7/exec';
        
        let savedQuestions = JSON.parse(localStorage.getItem('chatbotQuestions') || '[]');
        
        // Mise √† jour de la barre de progression
        function updateProgress() {
            const progress = Math.min((savedQuestions.length / 5) * 100, 100);
            document.getElementById('progressFill').style.width = progress + '%';
        }
        
        // Affichage des messages de statut
        function showMessage(message, type = 'success') {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 5000);
        }
        
        // Mise √† jour du compteur de questions
        function updateQuestionCounter() {
            const questionSelect = document.getElementById('questionNum');
            const counter = document.getElementById('questionNumber');
            
            questionSelect.addEventListener('change', function() {
                counter.textContent = this.value || '1';
            });
        }
        
        // Sauvegarde d'une question
        function saveForm() {
            const form = document.getElementById('chatbotForm');
            const formData = new FormData(form);
            
            // V√©rification des champs obligatoires
            const required = ['userName', 'questionNum', 'subTheme', 'questionAsked', 'botResponse', 'expectedResponse'];
            const missing = required.filter(field => !formData.get(field));
            
            // V√©rification des th√®mes (au moins un coch√©)
            const themes = Array.from(document.querySelectorAll('input[name="themes"]:checked')).map(cb => cb.value);
            if (themes.length === 0) missing.push('themes');
            
            if (missing.length > 0) {
                showMessage('‚ùå Veuillez remplir tous les champs obligatoires', 'warning');
                return;
            }
            
            // Cr√©ation de l'objet question
            const question = {
                id: Date.now(),
                date: new Date().toLocaleDateString('fr-FR'),
                userName: formData.get('userName'),
                questionNum: formData.get('questionNum'),
                themes: themes.join(', '),
                subTheme: formData.get('subTheme'),
                questionAsked: formData.get('questionAsked'),
                botResponse: formData.get('botResponse'),
                expectedResponse: formData.get('expectedResponse'),
                comments: formData.get('comments') || ''
            };
            
            // V√©rification si cette question existe d√©j√† (m√™me utilisateur + m√™me num√©ro)
            const existingIndex = savedQuestions.findIndex(q => 
                q.userName === question.userName && q.questionNum === question.questionNum
            );
            
            if (existingIndex >= 0) {
                savedQuestions[existingIndex] = question;
                showMessage(`‚úÖ Question ${question.questionNum} mise √† jour avec succ√®s !`);
            } else {
                savedQuestions.push(question);
                showMessage(`‚úÖ Question ${question.questionNum} sauvegard√©e avec succ√®s !`);
            }
            
            // Sauvegarde locale
            localStorage.setItem('chatbotQuestions', JSON.stringify(savedQuestions));
            updateProgress();
            
            // R√©initialiser le formulaire
            setTimeout(() => {
                form.reset();
                updateProgress();
            }, 1500);
        }
        
        // Envoi vers Google Sheets
        async function sendToGoogleSheets() {
            if (savedQuestions.length === 0) {
                showMessage('‚ùå Aucune question sauvegard√©e √† envoyer', 'warning');
                return;
            }
            
            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === 'VOTRE_URL_SCRIPT_GOOGLE_ICI') {
                showMessage('‚ö†Ô∏è URL Google Script non configur√©e. Contactez votre administrateur.', 'warning');
                return;
            }
            
            try {
                showMessage('üì§ Envoi en cours vers Google Sheets...', 'warning');
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        questions: savedQuestions,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    })
                });
                
                if (response.ok) {
                    const result = await response.text();
                    showMessage('‚úÖ Donn√©es envoy√©es avec succ√®s vers Google Sheets !');
                    
                    // Option : vider les donn√©es locales apr√®s envoi r√©ussi
                    if (confirm('‚úÖ Envoi r√©ussi ! Voulez-vous vider les donn√©es locales ?')) {
                        localStorage.removeItem('chatbotQuestions');
                        savedQuestions = [];
                        document.getElementById('chatbotForm').reset();
                        updateProgress();
                        showMessage('üóëÔ∏è Donn√©es locales supprim√©es');
                    }
                } else {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Erreur envoi Google Sheets:', error);
                showMessage('‚ùå Erreur lors de l\'envoi. V√©rifiez votre connexion internet.', 'warning');
            }
        }
        
        // Export en PDF
        function exportToPDF() {
            if (savedQuestions.length === 0) {
                showMessage('‚ùå Aucune question sauvegard√©e √† exporter', 'warning');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuration
            doc.setFont('helvetica');
            const pageHeight = doc.internal.pageSize.height;
            let yPosition = 20;
            
            // Titre
            doc.setFontSize(20);
            doc.text('Test ChatBot - R√©ponses Collect√©es', 105, yPosition, { align: 'center' });
            yPosition += 15;
            
            // Informations g√©n√©rales
            if (savedQuestions.length > 0) {
                doc.setFontSize(12);
                doc.text(`Utilisateur: ${savedQuestions[0].userName}`, 20, yPosition);
                yPosition += 10;
                doc.text(`Date d'export: ${new Date().toLocaleDateString('fr-FR')}`, 20, yPosition);
                yPosition += 10;
                doc.text(`Nombre de questions: ${savedQuestions.length}/5`, 20, yPosition);
                yPosition += 20;
            }
            
            // Questions
            savedQuestions.forEach((question, index) => {
                // V√©rification de l'espace disponible
                if (yPosition > pageHeight - 60) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Titre de la question
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`Question ${question.questionNum}`, 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                // Th√®mes
                doc.text(`Th√®mes: ${question.themes}`, 20, yPosition);
                yPosition += 7;
                doc.text(`Sous-th√®me: ${question.subTheme}`, 20, yPosition);
                yPosition += 10;
                
                // Question pos√©e
                doc.setFont('helvetica', 'bold');
                doc.text('Question pos√©e:', 20, yPosition);
                yPosition += 5;
                doc.setFont('helvetica', 'normal');
                const questionLines = doc.splitTextToSize(question.questionAsked, 170);
                doc.text(questionLines, 20, yPosition);
                yPosition += questionLines.length * 5 + 5;
                
                // R√©ponse du bot
                doc.setFont('helvetica', 'bold');
                doc.text('R√©ponse du ChatBot:', 20, yPosition);
                yPosition += 5;
                doc.setFont('helvetica', 'normal');
                const botLines = doc.splitTextToSize(question.botResponse, 170);
                doc.text(botLines, 20, yPosition);
                yPosition += botLines.length * 5 + 5;
                
                // R√©ponse attendue
                doc.setFont('helvetica', 'bold');
                doc.text('R√©ponse attendue:', 20, yPosition);
                yPosition += 5;
                doc.setFont('helvetica', 'normal');
                const expectedLines = doc.splitTextToSize(question.expectedResponse, 170);
                doc.text(expectedLines, 20, yPosition);
                yPosition += expectedLines.length * 5 + 5;
                
                // Commentaires
                if (question.comments) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('Commentaires:', 20, yPosition);
                    yPosition += 5;
                    doc.setFont('helvetica', 'normal');
                    const commentLines = doc.splitTextToSize(question.comments, 170);
                    doc.text(commentLines, 20, yPosition);
                    yPosition += commentLines.length * 5 + 5;
                }
                
                yPosition += 10;
                
                // Ligne de s√©paration
                if (index < savedQuestions.length - 1) {
                    doc.setDrawColor(200, 200, 200);
                    doc.line(20, yPosition, 190, yPosition);
                    yPosition += 15;
                }
            });
            
            // Sauvegarde du PDF
            const fileName = `Test_ChatBot_${savedQuestions[0]?.userName.split('@')[0]}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showMessage('üìÑ PDF g√©n√©r√© et t√©l√©charg√© avec succ√®s !');
        }
        
        // Vider le formulaire et les donn√©es
        function clearForm() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir vider toutes les donn√©es sauvegard√©es ?')) {
                localStorage.removeItem('chatbotQuestions');
                savedQuestions = [];
                document.getElementById('chatbotForm').reset();
                updateProgress();
                showMessage('üóëÔ∏è Toutes les donn√©es ont √©t√© supprim√©es');
            }
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress();
            updateQuestionCounter();
            
            if (savedQuestions.length > 0) {
                showMessage(`üìä ${savedQuestions.length} question(s) d√©j√† sauvegard√©e(s)`);
            }
        });
        
        // Sauvegarde automatique en cas de fermeture accidentelle
        window.addEventListener('beforeunload', function(e) {
            const form = document.getElementById('chatbotForm');
            const hasData = Array.from(new FormData(form)).some(([key, value]) => value.trim() !== '');
            
            if (hasData) {
                const message = 'Vous avez des donn√©es non sauvegard√©es. Voulez-vous vraiment quitter ?';
                e.returnValue = message;
                return message;
            }
        });
    </script>
</body>
</html>
