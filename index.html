<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test ChatBot – Collecte (UX+)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{
      --bg:#f7f9fc;--card:#fff;--text:#0f172a;--muted:#64748b;--brand:#4f46e5;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--border:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .container{max-width:940px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 30px rgba(2,6,23,.05);overflow:hidden}
    .header{background:var(--brand);color:#fff;padding:22px 24px}
    .header h1{margin:0 0 6px 0;font-size:22px;font-weight:700}
    .header p{margin:0;opacity:.9}
    .content{padding:24px}
    .bar{height:6px;background:#eaf0ff;border-radius:3px;overflow:hidden;margin-bottom:18px}
    .fill{height:100%;width:0;background:linear-gradient(90deg,var(--brand),#7c3aed)}
    .group{border:1px solid var(--border);border-radius:12px;padding:16px 16px 10px;margin-bottom:14px;background:#fbfcff}
    .group h4{margin:0 0 8px;font-size:15px}
    .help{font-size:12px;color:var(--muted);margin:4px 0 10px}
    label{font-weight:600;display:block;margin-bottom:6px}
    .req{color:var(--err)}
    input[type=email],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff}
    textarea{min-height:110px;resize:vertical}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 3px rgba(79,70,229,.12);border-color:var(--brand)}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .check{display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 10px;border-radius:10px;background:#fff}
    .row{display:grid;grid-template-columns:140px 1fr;gap:12px;align-items:start}
    .muted{color:var(--muted)}
    .buttons{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:22px}
    button{border:0;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer;transition:transform .06s ease,opacity .2s}
    button:active{transform:translateY(1px)}
    .b-save{background:#f59e0b;color:#fff}
    .b-view{background:#3b82f6;color:#fff}
    .b-export{background:#10b981;color:#fff}
    .b-send{background:#8b5cf6;color:#fff}
    .b-clear{background:#ef4444;color:#fff}
    .status{margin:12px 0 0;padding:10px;border-radius:10px;font-weight:600}
    .ok{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
    .warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
    .err{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .counter{display:inline-flex;align-items:center;gap:8px;background:var(--brand);color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;margin-bottom:8px}
    .chip{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .chip.sent{background:#ecfdf5;color:#065f46;border-color:#bbf7d0}
    .chip.draft{background:#f1f5f9;color:#334155}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,.45);z-index:40;padding:20px}
    .modal.open{display:grid}
    .modal .panel{max-width:1080px;width:100%;background:#fff;border-radius:14px;overflow:hidden;border:1px solid var(--border);box-shadow:0 20px 60px rgba(2,6,23,.25)}
    .panel-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--brand);color:#fff}
    .panel-body{padding:16px}
    .tools{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .tools input[type=text], .tools select{width:auto}
    .cards{display:grid;gap:12px}
    .card-q{border:1px solid var(--border);border-radius:12px;padding:14px;background:#fbfcff}
    .card-q h3{margin:0 0 6px;font-size:16px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .krow{display:grid;grid-template-columns:120px 1fr;gap:10px}
    .long{max-height:64px;overflow:hidden;position:relative}
    .long.expanded{max-height:none}
    .link{color:#1d4ed8;cursor:pointer;font-size:12px;text-decoration:underline;margin-top:6px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .sml{padding:8px 10px;border-radius:8px;font-size:12px}

    @media (max-width:720px){
      .row,.krow{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <h1>Test ChatBot – Collecte des questions</h1>
        <p>Enregistrez jusqu’à 5 questions, exportez en PDF et envoyez vers Google Forms.</p>
      </div>
      <div class="content">
        <div class="bar"><div id="progressFill" class="fill"></div></div>
        <div id="status"></div>

        <form id="form">
          <div class="group">
            <label for="email">Nom et e‑mail <span class="req">*</span></label>
            <input type="email" id="email" name="userName" placeholder="prenom.nom@entreprise.com" required />
            <div class="help">Votre e‑mail est mémorisé pour les prochaines questions.</div>
          </div>

          <div class="group">
            <div class="counter">Question <span id="qBadge">1</span> sur 5</div>
            <label for="qnum">Numéro de la question <span class="req">*</span></label>
            <select id="qnum" name="questionNum" required>
              <option value="">Sélectionnez…</option>
              <option value="1">Question 1</option>
              <option value="2">Question 2</option>
              <option value="3">Question 3</option>
              <option value="4">Question 4</option>
              <option value="5">Question 5</option>
            </select>
          </div>

          <div class="group">
            <label>Thèmes concernés <span class="req">*</span></label>
            <div class="help">Cochez tous les thèmes abordés</div>
            <div class="grid">
              <label class="check"><input type="checkbox" name="themes" value="Absences"/> Absences</label>
              <label class="check"><input type="checkbox" name="themes" value="Annulation"/> Annulation</label>
              <label class="check"><input type="checkbox" name="themes" value="Conseil"/> Conseil</label>
              <label class="check"><input type="checkbox" name="themes" value="Contrôle"/> Contrôle</label>
            </div>
          </div>

          <div class="group">
            <label>Sous‑thèmes concernés <span class="req">*</span></label>
            <div class="help">Cochez tous les sous‑thèmes pertinents</div>
            <h4>Absences</h4>
            <div class="grid">
              <label class="check"><input type="checkbox" name="subThemes" value="Absence entretien"/> Absence entretien</label>
              <label class="check"><input type="checkbox" name="subThemes" value="Annonce d'une absence"/> Annonce d'une absence</label>
            </div>
            <h4>Annulation</h4>
            <div class="grid">
              <label class="check"><input type="checkbox" name="subThemes" value="Annulation d'un dossier"/> Annulation d'un dossier</label>
            </div>
            <h4>Conseil</h4>
            <div class="grid">
              <label class="check"><input type="checkbox" name="subThemes" value="Diagnostic d'insertion"/> Diagnostic d'insertion</label>
              <label class="check"><input type="checkbox" name="subThemes" value="Évaluation approfondie"/> Évaluation approfondie</label>
              <label class="check"><input type="checkbox" name="subThemes" value="Fin de droit"/> Fin de droit</label>
              <label class="check"><input type="checkbox" name="subThemes" value="Mesures d'insertion"/> Mesures d'insertion</label>
              <label class="check"><input type="checkbox" name="subThemes" value="Octroi STAFE"/> Octroi STAFE</label>
              <label class="check"><input type="checkbox" name="subThemes" value="Stratégie de réinsertion"/> Stratégie de réinsertion</label>
              <label class="check"><input type="checkbox" name="subThemes" value="Structure des entretiens"/> Structure des entretiens</label>
              <label class="check"><input type="checkbox" name="subThemes" value="Task Force Entretiens"/> Task Force Entretiens</label>
              <label class="check"><input type="checkbox" name="subThemes" value="Visioconférence"/> Visioconférence</label>
            </div>
            <h4>Contrôle</h4>
            <div class="grid">
              <label class="check"><input type="checkbox" name="subThemes" value="Aptitude au placement"/> Aptitude au placement</label>
              <label class="check"><input type="checkbox" name="subThemes" value="Restitution des recherches d'emploi"/> Restitution des recherches d'emploi</label>
            </div>
          </div>

          <div class="group">
            <label for="qasked">Question posée au ChatBot <span class="req">*</span></label>
            <div class="help">Copiez‑collez exactement la question transmise</div>
            <textarea id="qasked" name="questionAsked" required placeholder="Coller votre question ici…"></textarea>
          </div>

          <div class="group">
            <label for="rbot">Réponse reçue du ChatBot <span class="req">*</span></label>
            <div class="help">Copiez‑collez la réponse complète</div>
            <textarea id="rbot" name="botResponse" required placeholder="Coller la réponse ici…"></textarea>
          </div>

          <div class="group">
            <label>Documents de référence attendus <span class="req">*</span></label>
            <div class="help">Sélectionnez les documents qui devraient servir de référence</div>
            <h4>Absences – Absence entretien</h4>
            <div class="grid">
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Entretien avant MMT.docx"/> Entretien avant MMT.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="DOC 002 Absences EC tableau synthèse.docx"/> DOC 002 Absences EC tableau synthèse.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="MAR 010 Management transmission au DJ"/> MAR 010 Management transmission au DJ</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="MAR 003 Annulation dossier DE"/> MAR 003 Annulation dossier DE</label>
            </div>
            <h4>Absences – Annonce d'une absence</h4>
            <div class="grid">
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Entretien de conseil (EC) après MMT"/> Entretien de conseil (EC) après MMT</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Allégement de conseil et de contrôle.docx"/> Allégement de conseil et de contrôle.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="APG Adoption.pdf"/> APG Adoption.pdf</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="APG Allocation à l'autre parent (au père ou à l'épouse de la mère).docx"/> APG Allocation à l'autre parent (au père ou à l'épouse de la mère).docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="APG Allocations de maternité.docx"/> APG Allocations de maternité.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="APG Allocations de prise en charge enfants.docx"/> APG Allocations de prise en charge enfants.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Incapacité de travail.docx"/> Incapacité de travail.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Jours sans contrôle.docx"/> Jours sans contrôle.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="OFAS"/> OFAS</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="DFAS"/> DFAS</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="OFSO"/> OFSO</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="SUVA"/> SUVA</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Sécurité social CHSS"/> Sécurité social CHSS</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="AVS/AI Allocation à l'autre parent AAP"/> AVS/AI Allocation à l'autre parent AAP</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="AVS/AI Allocation de maternité AMat"/> AVS/AI Allocation de maternité AMat</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="AVS/AI Allocation de prise en charge APC"/> AVS/AI Allocation de prise en charge APC</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="MAR 009 Incapacité de travail"/> MAR 009 Incapacité de travail</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="MAR 005 Événement"/> MAR 005 Événement</label>
            </div>
            <h4>Annulation – Annulation d'un dossier</h4>
            <div class="grid">
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Effectuer une annulation.docx"/> Effectuer une annulation.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="DOC 006 Annulation dossiers morts et délais"/> DOC 006 Annulation dossiers morts et délais</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="MAR 003 Annulation dossier DE"/> MAR 003 Annulation dossier DE</label>
            </div>
            <h4>Conseil – Diagnostic, évaluation, fin de droit, mesures, STAFE, stratégie, structure, TF, visio</h4>
            <div class="grid">
              <label class="check"><input type="checkbox" name="expectedDocuments" value="1er entretien de conseil (Diag).docx"/> 1er entretien de conseil (Diag).docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="DOC 007 Checklist EC"/> DOC 007 Checklist EC</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="DOC 004 EC présentiel, visio ou téléphone"/> DOC 004 EC présentiel, visio ou téléphone</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="MAR 005 Événement"/> MAR 005 Événement</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Évaluation approfondie.docx"/> Évaluation approfondie.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Fin d'indemnisation.docx"/> Fin d'indemnisation.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Mesures d'insertion.docx"/> Mesures d'insertion.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Octroyer un STAFE.docx"/> Octroyer un STAFE.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Établir la stratégie.docx"/> Établir la stratégie.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Fiches pratiques - Critères d'employabilité.docx"/> Fiches pratiques – Critères d'employabilité.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Nomenclature des objectifs.docx"/> Nomenclature des objectifs.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="MAR 006 Réinsertion Plan actions"/> MAR 006 Réinsertion Plan actions</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Structure des entretiens.docx"/> Structure des entretiens.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Task Force EC.docx"/> Task Force EC.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Guide et consignes.docx"/> Guide et consignes.docx</label>
            </div>
            <h4>Contrôle – AAP & RPE</h4>
            <div class="grid">
              <label class="check"><input type="checkbox" name="expectedDocuments" value="AAP examen.docx"/> AAP examen.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Activité indépendante durable.docx"/> Activité indépendante durable.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Checklist AAP.docx"/> Checklist AAP.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="Recherches d'emploi.docx"/> Recherches d'emploi.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="MAR 011 Demande évaluation aptitude DJ"/> MAR 011 Demande évaluation aptitude DJ</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="RPE - Arrêt du 15 août 2017 - CHAS.pdf"/> RPE – Arrêt du 15 août 2017 – CHAS.pdf</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="RPE - Note diminution en cas d'incapacité partiel ou GI.docx"/> RPE – Note diminution en cas d'incapacité partiel ou GI.docx</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="DOC 010 Note DJ - Recherches d'emploi avant chômage"/> DOC 010 Note DJ – Recherches d'emploi avant chômage</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="MAR 008 RPE Contrôle"/> MAR 008 RPE Contrôle</label>
              <label class="check"><input type="checkbox" name="expectedDocuments" value="MAR 010 Management transmission au DJ"/> MAR 010 Management transmission au DJ</label>
            </div>
          </div>

          <div class="group">
            <label for="ainfo">Complément d'information</label>
            <textarea id="ainfo" name="additionalInfo" placeholder="Précisions supplémentaires (optionnel)…"></textarea>
          </div>

          <div class="group">
            <label for="comments">Commentaires additionnels</label>
            <textarea id="comments" name="comments" placeholder="Remarques, suggestions (optionnel)…"></textarea>
          </div>

          <div class="buttons">
            <button type="button" class="b-save" id="bSave">Sauvegarder</button>
            <button type="button" class="b-view" id="bView">Voir mes questions (<span id="count">0</span>)</button>
            <button type="button" class="b-export" id="bPDF">Exporter PDF</button>
            <button type="button" class="b-send" id="bSend">Envoyer vers Google Forms</button>
            <button type="button" class="b-clear" id="bClear">Vider les données</button>
          </div>
        </form>

        <div id="statusBar" class="status" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="panel">
      <div class="panel-head">
        <strong>Mes questions sauvegardées</strong>
        <button class="sml" onclick="closeModal()" style="background:#fff;color:#111">Fermer</button>
      </div>
      <div class="panel-body">
        <div class="tools">
          <label class="check" style="border:none;padding:0;background:transparent"><span class="muted">Filtrer :</span></label>
          <select id="filter">
            <option value="all">Toutes</option>
            <option value="sent">Envoyées</option>
            <option value="draft">Non envoyées</option>
          </select>
          <input type="text" id="search" placeholder="Rechercher (question, réponse, doc, thème)…" />
        </div>
        <div class="cards" id="cards"></div>
      </div>
    </div>
  </div>

  <script>
    // ==== Config ====
    const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfnrld7MJR8uG4iiJDlbMDRcjTBWiwaN1gySWtsENVKS3I1FA/formResponse';
    const ENTRY = {
      email:'entry.2124536108',
      qnum:'entry.1139809027',
      themes:'entry.1654220128',
      subThemes:'entry.235677432',
      qasked:'entry.620424104',
      rbot:'entry.1896168519',
      docs:'entry.1217455196',
      ainfo:'entry.2014602471',
      comments:'entry.1998814617'
    };
    const MAX = 5;

    // ==== Storage helpers ====
    function loadAll(){
      try{const raw=localStorage.getItem('chatbotQuestions');return raw?JSON.parse(raw):[]}catch(e){localStorage.removeItem('chatbotQuestions');return[]}
    }
    function saveAll(arr){
      try{localStorage.setItem('chatbotQuestions',JSON.stringify(arr));return true}catch(e){toast("Impossible de sauvegarder (quota).",'err');return false}
    }
    function rememberEmail(v){ localStorage.setItem('chatbotUserEmail', v||''); }
    function recallEmail(){ return localStorage.getItem('chatbotUserEmail')||''; }

    let data = loadAll();

    // ==== UI refs ====
    const fill = document.getElementById('progressFill');
    const count = document.getElementById('count');
    const qBadge = document.getElementById('qBadge');
    const form = document.getElementById('form');
    const statusBar = document.getElementById('statusBar');

    function updateProgress(){ fill.style.width = Math.min((data.length/MAX)*100,100)+'%'; count.textContent = data.length; }
    function toast(msg,type='ok'){ statusBar.textContent=msg; statusBar.className='status '+(type==='ok'?'ok':type==='warn'?'warn':'err'); statusBar.style.display='block'; setTimeout(()=>statusBar.style.display='none',4000); window.scrollTo({top:0,behavior:'smooth'}); }

    // Next free number for this email
    function nextFree(email){
      const taken = new Set(data.filter(x=>x.userName===email).map(x=>String(x.questionNum)));
      for(let i=1;i<=MAX;i++){ if(!taken.has(String(i))) return i; }
      return null;
    }

    // Load entry into form
    function loadIntoForm(entry){
      form.reset();
      document.getElementById('email').value = entry.userName||'';
      document.getElementById('qnum').value = String(entry.questionNum||'');
      qBadge.textContent = String(entry.questionNum||'1');
      // themes
      (entry.themes||'').split(', ').filter(Boolean).forEach(v=>{
        const el = [...document.querySelectorAll('input[name="themes"]')].find(x=>x.value===v); if(el) el.checked=true;
      });
      // subThemes
      (entry.subThemes||'').split(', ').filter(Boolean).forEach(v=>{
        const el = [...document.querySelectorAll('input[name="subThemes"]')].find(x=>x.value===v); if(el) el.checked=true;
      });
      // docs
      (entry.expectedDocuments||'').split(/,\s*/).filter(Boolean).forEach(v=>{
        const el = [...document.querySelectorAll('input[name="expectedDocuments"]')].find(x=>x.value===v); if(el) el.checked=true;
      });
      document.getElementById('qasked').value = entry.questionAsked||'';
      document.getElementById('rbot').value = entry.botResponse||'';
      document.getElementById('ainfo').value = entry.additionalInfo||'';
      document.getElementById('comments').value = entry.comments||'';
      toast('Question chargée pour édition');
    }

    // Collect current form values
    function collect(){
      const email = document.getElementById('email').value.trim();
      const qnum = document.getElementById('qnum').value.trim();
      const themes = [...document.querySelectorAll('input[name="themes"]:checked')].map(x=>x.value);
      const sub = [...document.querySelectorAll('input[name="subThemes"]:checked')].map(x=>x.value);
      const docs = [...document.querySelectorAll('input[name="expectedDocuments"]:checked')].map(x=>x.value);
      const qasked = document.getElementById('qasked').value.trim();
      const rbot = document.getElementById('rbot').value.trim();
      const ainfo = document.getElementById('ainfo').value.trim();
      const comments = document.getElementById('comments').value.trim();
      return {userName:email,questionNum:qnum,themes:themes.join(', '),subThemes:sub.join(', '),expectedDocuments:docs.join(', '),questionAsked:qasked,botResponse:rbot,additionalInfo:ainfo,comments, date:new Date().toLocaleDateString('fr-CH')};
    }

    function validate(entry){
      const miss=[];
      if(!entry.userName) miss.push('e‑mail');
      if(!entry.questionNum) miss.push('numéro de question');
      if(!entry.questionAsked) miss.push('question');
      if(!entry.botResponse) miss.push('réponse');
      if(!entry.themes) miss.push('au moins un thème');
      if(!entry.subThemes) miss.push('au moins un sous‑thème');
      if(!entry.expectedDocuments) miss.push('au moins un document');
      if(miss.length){ toast('Champs requis manquants : '+miss.join(', '),'warn'); return false; }
      return true;
    }

    function save(){
      const entry = collect();
      if(!validate(entry)) return;
      // check duplicate for this email+qnum
      const idx = data.findIndex(x=>x.userName===entry.userName && String(x.questionNum)===String(entry.questionNum));
      if(idx>-1){
        if(confirm(`La question ${entry.questionNum} existe déjà pour ${entry.userName}. La remplacer ?`)){
          entry.sentAt = data[idx].sentAt||undefined; // conserver statut d'envoi
          data[idx]=entry; if(!saveAll(data)) return; toast(`Question ${entry.questionNum} mise à jour.`);
        }else{
          const nf = nextFree(entry.userName);
          if(nf){ entry.questionNum = String(nf); data.push(entry); if(!saveAll(data)) return; toast(`Question enregistrée sous le numéro ${nf}.`); }
          else { toast('Limite de 5 questions atteinte pour cet e‑mail.','warn'); return; }
        }
      }else{
        if(data.length>=MAX){ toast(`Limite globale atteinte (${MAX}). Supprimez une entrée pour continuer.`,'warn'); return; }
        data.push(entry); if(!saveAll(data)) return; toast(`Question ${entry.questionNum} sauvegardée.`);
      }
      updateProgress();
      // prepare next: keep email, advance qnum, vider textes & cases
      const email = entry.userName; rememberEmail(email);
      const nf = nextFree(email); // peut être null si plein
      document.getElementById('qasked').value='';
      document.getElementById('rbot').value='';
      document.getElementById('ainfo').value='';
      document.getElementById('comments').value='';
      document.querySelectorAll('input[name="themes"],input[name="subThemes"],input[name="expectedDocuments"]').forEach(el=>el.checked=false);
      if(nf){ document.getElementById('qnum').value=String(nf); qBadge.textContent=String(nf);} else { qBadge.textContent=String(entry.questionNum); }
    }

    // Export PDF (résumé lisible)
    function exportPDF(){
      if(!data.length){ toast('Aucune question à exporter.','warn'); return; }
      const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y=18;
      doc.setFont('helvetica',''); doc.setFontSize(16); doc.text('Test ChatBot – Export',14,y); y+=10;
      doc.setFontSize(11); doc.text(`Utilisateur: ${data[0].userName||''}`,14,y); y+=6;
      doc.text(`Date: ${new Date().toLocaleDateString('fr-CH')}`,14,y); y+=10;
      data.forEach((q,i)=>{ if(y>275){ doc.addPage(); y=18; }
        doc.setFontSize(13); doc.text(`Question ${q.questionNum}${q.sentAt?' (envoyée)':''}`,14,y); y+=6;
        doc.setFontSize(10);
        const lines=(t,w)=>doc.splitTextToSize(t||'N/A',w);
        doc.text(`Thèmes: ${q.themes||'N/A'}`,14,y); y+=5;
        doc.text(`Sous‑thèmes: ${q.subThemes||'N/A'}`,14,y); y+=5;
        doc.text('Question :',14,y); y+=5; lines(q.questionAsked,180).forEach(l=>{doc.text(l,18,y); y+=5;});
        doc.text('Réponse :',14,y); y+=5; lines(q.botResponse,180).forEach(l=>{doc.text(l,18,y); y+=5;});
        doc.text('Documents :',14,y); y+=5; lines((q.expectedDocuments||'Aucun').split(',').map(s=>'• '+s.trim()).join('\n'),180).forEach(l=>{doc.text(l,18,y); y+=5;});
        y+=4; doc.setDrawColor(220); doc.line(14,y,196,y); y+=6;
      });
      doc.save(`ChatBot_Export_${new Date().toISOString().slice(0,10)}.pdf`);
      toast('PDF exporté.');
    }

    // Send to Google Forms (envoie toutes les non envoyées)
    async function sendAll(){
      if(!data.length){ toast('Aucune question à envoyer.','warn'); return; }
      let toSend = data.filter(x=>!x.sentAt);
      if(!toSend.length){ toast('Tout a déjà été envoyé.','ok'); return; }
      toast(`Envoi de ${toSend.length} question(s)…`,'warn');
      for(const q of toSend){
        const fd = new FormData();
        fd.append(ENTRY.email, q.userName||'');
        fd.append(ENTRY.qnum, q.questionNum||'');
        fd.append(ENTRY.themes, q.themes||'');
        fd.append(ENTRY.subThemes, q.subThemes||'');
        fd.append(ENTRY.qasked, q.questionAsked||'');
        fd.append(ENTRY.rbot, q.botResponse||'');
        fd.append(ENTRY.docs, q.expectedDocuments||'');
        fd.append(ENTRY.ainfo, q.additionalInfo||'');
        fd.append(ENTRY.comments, q.comments||'');
        try{ await fetch(GOOGLE_FORM_URL,{method:'POST',body:fd}); q.sentAt = new Date().toISOString(); saveAll(data); }
        catch(e){ /* Google Forms peut "répondre" sans CORS; on ignore l'erreur */ }
        await new Promise(r=>setTimeout(r, 600));
      }
      toast('Envoi terminé.');
      renderCards(); updateProgress();
    }

    // Clear all
    function clearAll(){ if(confirm('Supprimer toutes les données locales ?')){ data=[]; saveAll(data); updateProgress(); count.textContent='0'; toast('Toutes les données ont été supprimées.'); }}

    // Modal logic
    const modal = document.getElementById('modal');
    const cards = document.getElementById('cards');
    const filter = document.getElementById('filter');
    const search = document.getElementById('search');

    function openModal(){ modal.classList.add('open'); renderCards(); }
    function closeModal(){ modal.classList.remove('open'); }

    function escHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    function matchFilter(q){
      const f = filter.value;
      if(f==='sent' && !q.sentAt) return false;
      if(f==='draft' && q.sentAt) return false;
      const term = search.value.trim().toLowerCase();
      if(!term) return true;
      const hay = [q.questionAsked,q.botResponse,q.expectedDocuments,q.themes,q.subThemes].join('\n').toLowerCase();
      return hay.includes(term);
    }

    function renderCards(){
      if(!cards) return;
      let list = loadAll(); // reload fresh
      data = list; // keep in sync
      const arr = list.filter(matchFilter);
      if(!arr.length){ cards.innerHTML = '<div class="muted">Aucune entrée.</div>'; updateProgress(); return; }
      cards.innerHTML = arr.map((q,i)=>{
        const status = q.sentAt?'<span class="chip sent">Envoyée</span>':'<span class="chip draft">Brouillon</span>';
        const short = (t)=>{ if(!t) return 'N/A'; return t.length>140? escHTML(t.slice(0,140))+"…" : escHTML(t); };
        const id = q.userName+'__'+q.questionNum;
        return `
          <div class="card-q" data-id="${escHTML(id)}">
            <h3>Question ${escHTML(q.questionNum||'')} ${status}</h3>
            <div class="meta">
              <span class="chip">${escHTML(q.userName||'')}</span>
              <span class="chip">${escHTML(q.date||'')}</span>
            </div>
            <div class="krow"><div class="muted">Thèmes</div><div>${escHTML(q.themes||'—')}</div></div>
            <div class="krow"><div class="muted">Sous‑thèmes</div><div>${escHTML(q.subThemes||'—')}</div></div>
            <div class="krow"><div class="muted">Question</div>
              <div class="long" id="q-${i}" data-full="${encodeURIComponent(q.questionAsked||'')}">${short(q.questionAsked)}${(q.questionAsked||'').length>140?'<div class="link" onclick="toggleLong(\'q-"+i+"\')">Voir plus</div>':''}</div>
            </div>
            <div class="krow"><div class="muted">Réponse</div>
              <div class="long" id="r-${i}" data-full="${encodeURIComponent(q.botResponse||'')}">${short(q.botResponse)}${(q.botResponse||'').length>140?'<div class="link" onclick="toggleLong(\'r-"+i+"\')">Voir plus</div>':''}</div>
            </div>
            <div class="krow"><div class="muted">Documents</div><div>${escHTML(q.expectedDocuments||'—')}</div></div>
            <div class="actions">
              <button class="sml" onclick="editEntry('${encodeURIComponent(id)}')">Éditer</button>
              <button class="sml" onclick="delEntry('${encodeURIComponent(id)}')" style="background:#fee2e2;color:#991b1b">Supprimer</button>
              ${q.sentAt? '' : '<button class="sml" onclick="markSent(\''+encodeURIComponent(id)+'\')" style="background:#ecfdf5;color:#065f46">Marquer envoyée</button>'}
            </div>
          </div>`
      }).join('');
      updateProgress();
    }

    function getById(encoded){ const id=decodeURIComponent(encoded); const [u,qn]=id.split('__'); return data.findIndex(x=>x.userName===u && String(x.questionNum)===String(qn)); }
    function editEntry(encoded){ const i=getById(encoded); if(i>-1){ loadIntoForm(data[i]); window.scrollTo({top:0,behavior:'smooth'}); } }
    function delEntry(encoded){ const i=getById(encoded); if(i>-1 && confirm('Supprimer cette entrée ?')){ data.splice(i,1); saveAll(data); renderCards(); updateProgress(); toast('Entrée supprimée.'); } }
    function markSent(encoded){ const i=getById(encoded); if(i>-1){ data[i].sentAt=new Date().toISOString(); saveAll(data); renderCards(); toast('Marquée comme envoyée.'); } }

    function toggleLong(id){ const el=document.getElementById(id); if(!el) return; const full=decodeURIComponent(el.dataset.full||''); if(el.classList.contains('expanded')){ el.classList.remove('expanded'); el.innerHTML=escHTML(full.length>140?full.slice(0,140)+'…':full)+(full.length>140?'<div class="link" onclick="toggleLong(\''+id+'\')">Voir plus</div>':''); } else { el.classList.add('expanded'); el.innerHTML=escHTML(full)+'<div class="link" onclick="toggleLong(\''+id+'\')">Voir moins</div>'; } }

    // ==== Events ====
    document.getElementById('bSave').addEventListener('click', save);
    document.getElementById('bPDF').addEventListener('click', exportPDF);
    document.getElementById('bSend').addEventListener('click', sendAll);
    document.getElementById('bClear').addEventListener('click', clearAll);
    document.getElementById('bView').addEventListener('click', openModal);
    document.getElementById('qnum').addEventListener('change', e=>{ qBadge.textContent=e.target.value||'1'; });
    document.getElementById('email').addEventListener('input', e=>{ rememberEmail(e.target.value); });
    filter.addEventListener('change', renderCards); search.addEventListener('input', renderCards);
    window.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

    // Draft autosave – user friendly
    const DRAFT_KEY='chatbotDraft';
    function saveDraft(){ localStorage.setItem(DRAFT_KEY, JSON.stringify(collect())); }
    function loadDraft(){ try{ const d=JSON.parse(localStorage.getItem(DRAFT_KEY)||'null'); if(d && !data.find(x=>x.userName===d.userName && x.questionNum===d.questionNum)) { loadIntoForm(d); } }catch(_){} }
    form.addEventListener('input', ()=>{ try{ saveDraft(); }catch(_){} });

    // Init
    (function init(){
      updateProgress();
      const remembered = recallEmail();
      if(remembered){ document.getElementById('email').value=remembered; const nf = nextFree(remembered); if(nf){ document.getElementById('qnum').value=String(nf); qBadge.textContent=String(nf); } }
      loadDraft();
      if(data.length){ toast(`${data.length} question(s) déjà sauvegardée(s).`,'ok'); }
    })();
  </script>
</body>
</html>
